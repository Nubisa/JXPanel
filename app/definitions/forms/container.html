<script>
    if(!window.jxForms){
        window.jxForms = {};
    }

    window.jxForms["{{form.id}}"] = {
        ntc : {},
        apply:function(){
            var _this = window.jxForms["{{form.id}}"];

            var values = {};
            var failed = false;
            utils.jxAddMessage();

            // hiding previous errors
            _this.hideErrors();

            $("input").each(function(index, el) {

                var isRequired = $(el).hasClass("required");
                var type = $(el).attr('type');
                var val = type === 'checkbox' ? el.checked : el.value;
                var empty = (type === 'checkbox' && !val) || (type !== 'checkbox' && !val.trim().length);

                if (isRequired && empty) {
                    _this.showError(this.id, "{{label.ValueRequired}}");
                    failed = true;
                    return;
                }

                values[this.id] = val;
            });

            $("select").each(function(index, el) {

                var isRequired = $(el).hasClass("required");
                var selected = $(el).find('option:selected');

                if (isRequired && !selected.index()) {
                    _this.showError(this.id, "{{label.ValueRequired}}");
                    failed = true;
                    return;
                }

                values[this.id] = selected.index() ? selected.val() : "";
            });

            $("textarea").each(function(index, el) {

                var isRequired = $(el).hasClass("required");
                var val = el.value;
                var empty = !val.trim().length;

                if (isRequired && empty) {
                    _this.showError(this.id, "{{label.ValueRequired}}");
                    failed = true;
                    return;
                }

                values[this.id] = val;
            });


            if(!failed){
                window.toServer('sessionApply', {form: '{{form.id}}', controls: values }, function (param) {

                    var ntc_displayed = false;
                    if (param.arr) {
                        _this.hideErrors();
                        for(var o in param.arr) {
                            if (param.arr[o].ntc && !ntc_displayed) { // need to confirm

                                var ntc = param.arr[o].ntc;
                                utils.jxConfirm('<i class="fa fa-user txt-color-orangeDark"></i> ' + ntc.title, ntc.msg, function(ButtonPressed) {

                                    if (ButtonPressed === "{{label.Yes}}") {

                                        _this.ntc[ntc.id] = ntc.id_ok;
                                        var div = document.getElementById(ntc.id_ok + '_group');
                                        if (!div)
                                            $(ntc.html).insertAfter("#" + ntc.id + "_group");

                                        $('#' + ntc.id_ok).prop("checked", true);
                                        $('#' + ntc.id_ok + '_group').css("margin-top","-20px");
//                                        setTimeout(_this.apply, 50);
                                    } else {
                                        _this.showError(ntc.id, ntc.title);
                                    }
                                });
                                ntc_displayed = true;
                            } else {
                                _this.showError(param.arr[o].id, param.arr[o].msg);
                            }
                        }
                    } else {
                        document.location = "{{form.onSubmitSuccess}}";
                    }
                }, true);
            }
        },
        hideErrors : function() {
            var _this = window.jxForms["{{form.id}}"];
            $("input, select").each(function() {
                $("#" + this.id + "_note").remove();
                $("#" + this.id + "_group").removeClass("has-error");
                //                $("#" + o + "_group").addClass("has-success");
            });
            _this.focused = false;
        },
        showError : function(id, msg) {

            var _this = window.jxForms["{{form.id}}"];

            if (id && document.getElementById(id)) {
                var str = '<span class="help-block" id="'+id+'_note" style="margin-bottom: 0px;"><i class="fa fa-warning"></i> ' + msg + '</span>';
                $(str).insertAfter("#" + id);
//                $("#" + id + "_group").removeClass("has-success");
                $("#" + id + "_group").addClass("has-error");
            } else {
                utils.jxAddMessage('danger', msg);
            }

            if (!_this.focused) {
                _this.focused = true;
                $("#" + id).focus();
                window.scrollBy(0,-100);
            }
        }
    };
</script>

<p id="jxFormMessage"></p>

<div id="jxform">
    {{form.contents}}
</div>
<legend></legend>
<div class="form-group" id="jxform_buttons" style="display: none; margin-bottom: 30px; margin-top: 20px;">
    <label class="col-md-2 control-label"></label>

    <div class="col-md-4" style="padding-left: 0px">
        <span id="buttons" class="jxbuttons">
            <i class="fa fa-fw fa-align-justify" style="color: #757a7b;"></i>

            <button type="submit" onclick="return false;" style="display: none;"></button>

            <a id="jxFormBtnSubmit" type="submit" class="jxbtn" onclick="{{form.submitOnClick}}">
                <i class="fa fa-check"></i><span class="dummy-label">{{label.Apply}}</span>
            </a>
            <a class="jxbtn" class="jxbtn" onclick="location = '{{form.onSubmitCancel}}';">
                <i class="fa fa-times"></i><span class="dummy-label">{{label.Cancel}}</span>
            </a>
        </span>
    </div>
</div>

<br><br>


<script>

    window.jxTemplateReadyForjxm = function() {
        jxcore.Call('getForm', { form : '{{form.id}}' }, function(param) {
            var div = document.getElementById('jxform');
            if (!div) {
                utils.jxAddMessage("danger", "{{labels.NoDiv}}");
                return;
            }

            if (param.err) {
                utils.jxAddMessage("danger", param.err);
                div.innerHTML = param.err;
            } else {
                $("#jxform_buttons").show();
                div.innerHTML = param.html;

                var script = document.createElement("script");
                script.innerHTML = param.js;
                document.head.appendChild(script);

                // first load of a form applog
                var logDiv = document.getElementById("jxAppLog");
                if (logDiv)
                    utils.jxAppViewLog();

                if (!param.new) {
                    $("#jxAppLog_Tab").removeClass("disabled");
                    $("#jxAppLog_Tab a").attr("href", "applog.html");
                }
            }

            if (param.hideForm) {
                $("#wid-id-0").hide();
            } else {
                $("#wid-id-0").show();
            }

            // focus on first control
            $("input, select").first().focus();
        });

        utils.jxAppViewLog = function(remove) {

            var _this = window.jxForms["{{form.id}}"];

            var values = {};
            if (remove) {
                values = -1;
            } else {
                $("input").each(function(index, el) {
                    values[this.id] = el.value;
                });
            }

            jxcore.Call('appViewLog', { controls : values }, function(param) {

                if (param.err) {
                    utils.jxAddMessage('danger', param.err)
                } else {
                    if (param.url) {
                        document.location = param.url;
                        return;
                    }

                    $("#jxAppLog").html(param.log);
                    $("#jxAppLogSize").html(param.size ? param.size + " bytes" : "{{label.JXcoreAppLogEmpty}}");

                    if (param.log && param.log.length)
                        $("#jxAppLogClearBtn").show();
                    else
                        $("#jxAppLogClearBtn").hide();

                }

                if (param.err) {
                    $("#wid-id-0").hide();
                    $("#wid-id-1").hide();
                } else {
                    $("#wid-id-0").show();
                    $("#wid-id-1").show();
                }

            });
            return false;
        };


        utils.jxAppInstall = function(appName, install) {
            window.jxstatus = install ? "{{label.JXcoreAppAppInstalling}}" : "{{label.JXcoreAppAppUnInstalling}}";
            window.jxstatus = window.jxstatus.replace("%s", appName);
            return utils.jxCall("appInstall", install, appName);
        };

    };

</script>