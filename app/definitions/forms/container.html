<!--<article class="col-sm-12 col-md-16 col-lg-12">-->
<article class="sortable-grid ui-sortable">

    <script>
        if(!window.jxForms){
            window.jxForms = {};
        }

        window.jxForms["{{form.id}}"] = {
            created: false,
            controls:{},
            apply:function(){
                var _this = window.jxForms["{{form.id}}"];

                var values = {};
                var failed = false;
                utils.jxAddMessage();

                for(var o in _this.controls){
                    var type = _this.controls[o].type;
                    var required = _this.controls[o].required;
                    var name = _this.controls[o].name;
                    var _t = _this.controls[o]._t;

                    if(type == 'text' || type == 'password' || type == 'textarea'){
                        values[_t] = document.getElementById(o).value;
                        if(required && !values[_t].trim().length){
                            utils.jxAddMessage('danger',  name + ":: {{label.ValueRequired}}");
                            failed = true;
                        }
                    }
                    else if (type == 'select'){
                        var index = document.getElementById(o).selectedIndex;
                        var value = document.getElementById(o).value;

                        if(required && index <= 0){
                            utils.jxAddMessage('danger',  name + ":: {{label.ValueRequired}}");
                            failed = true;
                        }
                        else{
                            if(index<=0)
                                values[_t] = "";
                            else
                                values[_t] = value;
                        }
                    }
                    else if (type == 'checkbox'){
                        var value = document.getElementById(o).checked;

                        if(required && !value){
                            utils.jxAddMessage('danger',  name + ":: {{label.ValueRequired}}");
                            failed = true;
                        }
                        else{
                            values[_t] = value;
                        }
                    }
                }

                if(!failed){
                    window.toServer('sessionApply', {form: '{{form.id}}', controls: values }, function (param) {

                        if (param.arr) {

                            var aliases = {};
                            for(var o in _this.controls){
                                aliases[_this.controls[o].name] = o;
                                $("#" + o + "_note").remove();
                                $("#" + o + "_group").removeClass("has-error");
//                                $("#" + o + "_group").addClass("has-success");
                            }

                            var focus = null;
                            for(var o in param.arr){
                                var id = aliases[param.arr[o].control];

                                if (id && document.getElementById(id)) {
                                    var str = '<span class="help-block" id="'+id+'_note"><i class="fa fa-warning"></i> ' + param.arr[o].msg + '</span>';
                                    $(str).insertAfter("#" + id);
//                                    $("#" + id + "_group").removeClass("has-success");
                                    $("#" + id + "_group").addClass("has-error");
                                    if (!focus) focus = id;
                                } else {
                                    utils.jxAddMessage('danger', param.arr[o].control ? (param.arr[o].control + ":" + param.arr[o].msg) : param.arr[o].msg);
                                }

                                if (focus) {
                                    $("#" + focus).focus();
                                    window.scrollBy(0,-100);
                                }
                            }

                            utils.jxAddMessage('danger', "{{label.FormError}}");
                        } else {
                            document.location = "{{form.onSubmitSuccess}}";
                        }
                    }, true);
                }
            },

            loadDynamic: function () {
                var _this = window.jxForms["{{form.id}}"];

                if (!_this.created) {
                    setTimeout(_this.loadDynamic, 100);
                    return;
                }

                // loading jxm dynamic values
                var frm = window.jxForms["{{form.id}}"];
                if (!frm || !frm.controls) return;

                var dynarr = [];
                for (var a in frm.controls) {
                    var ctrl = frm.controls[a];
                    if (typeof ctrl.dynamic !== 'undefined' && ctrl.dynamic !== null) {
                        dynarr.push(ctrl._t);
                    }
                }

//                utils.jxAddMessage("info", JSON.stringify(dynarr));

                for (var a in dynarr) {
                    jxcore.Call('getControlsValues', { form: '{{form.id}}', control: dynarr[a] }, function (param) {

//                        utils.jxAddMessage("info", "received values " + JSON.stringify(param));
//                        utils.jxAddMessage("info", "param.control " + JSON.stringify(param.control));
//                        utils.jxAddMessage("info", "param.values " + JSON.stringify(param.values));

                        if (param.err) {
                            utils.jxAddMessage('danger', param.err);
                        } else {
                            _this.addToCombo(param.control, param.values);
                        }
                    });
                }
            },
            addToCombo : function (ctrl_name, values) {
                var _this = window.jxForms["{{form.id}}"];

//                utils.jxAddMessage("warning", ctrl_name + "." + JSON.stringify(values));

                // finding control id
                var ctrl_id = null;
                for (var o in _this.controls)
                    if (_this.controls[o]._t == ctrl_name)
                        ctrl_id = o;

                if (!ctrl_id) return;
                var combo = document.getElementById(ctrl_id);
                if (!combo) return;

//                utils.jxAddMessage("info", "values "  + JSON.stringify(values));

                var selected = false;
                // adding combo options
                for (var id in values) {
                    var item = values[id];
                    var option = document.createElement('option');
                    option.text = item.txt;
                    option.value = item.id;

//                    utils.jxAddMessage("danger", item.txt + ", " + JSON.stringify(_this.controls[ctrl_id]));
                    if (item.id + '' === _this.controls[ctrl_id].dynamic + '') {
                        option.selected = true;
                        selected = true;
                    }
                    combo.add(option);
                }

                _this.controls[ctrl_id].dynamic = null;
                if (!selected)
                    combo.selectedIndex = 0;
            }
        };
    </script>
    <!-- Widget ID (each widget will need unique ID)-->
    <div class="jarviswidget jarviswidget-color-darken" id="wid-id-0" data-widget-togglebutton="false" data-widget-editbutton="false" data-widget-deletebutton="false" style="display: none;">

        <header>
            {{form.icon}}
            <h2 style="width:1px;overflow:visible"><nobr><strong>{{form.name}}</strong></nobr></h2>

        </header>

        <!-- widget div-->
        <div>

            <!-- widget edit box -->
            <div class="jarviswidget-editbox">
                <!-- This area used as dropdown edit box -->

            </div>
            <!-- end widget edit box -->

            <!-- widget content -->
            <div class="widget-body">

                <div id="jxform">
                    {{form.contents}}
                </div>

                <div class="form-group" id="jxform_buttons" style="display: none; margin-bottom: 30px;">
                    <label class="col-md-2 control-label"></label>
                    <div class="col-md-4" style="padding-left: 0px">
                        <button id="jxFormBtnSubmit" type="submit" class="btn btn-labeled btn-primary"  onclick="{{form.submitOnClick}}">
                             <span class="btn-label">
                              <i class="glyphicon glyphicon-ok"></i>
                             </span>
                                    {{label.Apply}}
                        </button>
                        &nbsp;
                        <button type="button" class="btn btn-labeled btn-danger" onclick="location = '{{form.onSubmitCancel}}';">
                             <span class="btn-label">
                              <i class="glyphicon glyphicon-remove"></i>
                             </span>
                            {{label.Cancel}}
                        </button>
                    </div>
                </div>

                <br>
            </div>
            <!-- end widget div -->

        </div>
        <!-- end widget -->

    </div>

</article>
<!-- WIDGET END -->


<script>

    window.jxTemplateReadyForjxm = function() {
        jxcore.Call('getForm', { form : '{{form.id}}' }, function(param) {
            var div = document.getElementById('jxform');
            if (!div) {
                utils.jxAddMessage("danger", "{{labels.NoDiv}}");
                return;
            }

            if (param.err) {
                utils.jxAddMessage("danger", param.err);
                div.innerHTML = param.err;
            } else {
                $("#jxform_buttons").show();
                div.innerHTML = param.html;

                var script = document.createElement("script");
                script.innerHTML = param.js;
                document.head.appendChild(script);
                window.jxForms["{{form.id}}"].loadDynamic();

                // first load of a form applog
                var logDiv = document.getElementById("jxAppLog");
                if (logDiv)
                    utils.jxAppViewLog();
            }

            if (param.hideForm) {
                $("#wid-id-0").hide();
            } else {
                $("#wid-id-0").show();
            }

            // focus on first control
            var _this = window.jxForms["{{form.id}}"];
            for(var o in _this.controls) {
                $("#" + o).focus();
                break;
            }
        });

        utils.jxAppViewLog = function(remove) {

            var _this = window.jxForms["{{form.id}}"];

            var lines = null;
            if (remove) {
                lines = -1;
            } else {
                for(var o in _this.controls) {
                    var _t = _this.controls[o]._t;

                    if (_t === "app_log_last_lines")
                       lines = document.getElementById(o).value;
                }
            }

            jxcore.Call('appViewLog', { lines : lines }, function(param) {

                if (param.err) {
                    utils.jxAddMessage('danger', param.err)
                } else {
                    if (param.url) {
                        document.location - param.url;
                        return;
                    }

                    $("#jxAppLog").html(param.log);
                    $("#jxAppLogSize").html((param.size  || 0)+ " bytes");

                    if (param.log && param.log.length)
                        $("#jxAppLogClearBtn").show();
                    else
                        $("#jxAppLogClearBtn").hide();

                }

                if (param.err) {
                    $("#wid-id-0").hide();
                    $("#wid-id-1").hide();
                } else {
                    $("#wid-id-0").show();
                    $("#wid-id-1").show();
                }

            });
            return false;
        };

    };

</script>