<script>
    if(!window.jxForms){
        window.jxForms = {};
    }

    window.jxForms["{{form.id}}"] = {
        created: false,
        controls:{},
        apply:function(){
            var _this = window.jxForms["{{form.id}}"];

            var values = {};
            var failed = false;
            utils.jxAddMessage();

            for(var o in _this.controls){
                var type = _this.controls[o].type;
                var required = _this.controls[o].required;
                var name = _this.controls[o].name;

                if(type == 'text' || type == 'password' || type == 'textarea'){
                    values[o] = document.getElementById(o).value;
                    if(required && !values[o].trim().length){
                        utils.jxAddMessage('danger',  name + ":: {{label.ValueRequired}}");
                        failed = true;
                    }
                }
                else if (type == 'select'){
                    var index = document.getElementById(o).selectedIndex;
                    var value = document.getElementById(o).value;

                    if(required && index <= 0){
                        utils.jxAddMessage('danger',  name + ":: {{label.ValueRequired}}");
                        failed = true;
                    }
                    else{
                        if(index<=0)
                            values[o] = "";
                        else
                            values[o] = value;
                    }
                }
                else if (type == 'checkbox'){
                    var value = document.getElementById(o).checked;

                    if(required && !value){
                        utils.jxAddMessage('danger',  name + ":: {{label.ValueRequired}}");
                        failed = true;
                    }
                    else{
                        values[o] = value;
                    }
                }
            }

            if(!failed){
                window.toServer('sessionApply', {form: '{{form.id}}', controls: values }, function (param) {

                    if (param.arr) {

                        var aliases = {};
                        for(var o in _this.controls){
                            aliases[_this.controls[o].name] = o;
                            $("#" + o + "_note").remove();
                            $("#" + o + "_group").removeClass("has-error");
//                                $("#" + o + "_group").addClass("has-success");
                        }

                        var focus = null;
                        var bubbled = false;
                        for(var o in param.arr){
                            var id = aliases[param.arr[o].control];

                            if (id && document.getElementById(id)) {
                                var str = '<span class="help-block" id="'+id+'_note"><i class="fa fa-warning"></i> ' + param.arr[o].msg + '</span>';
                                $(str).insertAfter("#" + id);
//                                    $("#" + id + "_group").removeClass("has-success");
                                $("#" + id + "_group").addClass("has-error");
                                if (!focus) focus = id;
                            } else {
                                bubbled = true;
                                utils.jxAddMessage('danger', param.arr[o].control ? (param.arr[o].control + ":" + param.arr[o].msg) : param.arr[o].msg);
                            }

                            if (focus) {
                                $("#" + focus).focus();
                                window.scrollBy(0,-100);
                            }
                        }

                        if (!bubbled)
                            utils.jxAddMessage('danger', "{{label.FormError}}");
                    } else {
                        document.location = "{{form.onSubmitSuccess}}";
                    }
                }, true);
            }
        }
    };
</script>

<!--<article class="col-sm-12 col-md-16 col-lg-12">-->
<!--<article class="sortable-grid ui-sortable">-->

    <!-- Widget ID (each widget will need unique ID)-->
    <!--<div class="jarviswidget jarviswidget-color-darken" id="wid-id-0" data-widget-togglebutton="false" data-widget-editbutton="false" data-widget-deletebutton="false" style="display: none;">-->

        <!--<header>-->
            <!--{{form.icon}}-->
            <!--<h2 style="width:1px;overflow:visible"><nobr><strong>{{form.displayName}}</strong></nobr></h2>-->

        <!--</header>-->

        <!-- widget div-->
        <!--<div>-->

            <!-- widget edit box -->
            <!--<div class="jarviswidget-editbox">-->


            <!--</div>-->
            <!-- end widget edit box -->

            <!-- widget content -->
            <!--<div class="widget-body">-->

                <div id="jxform">
                    {{form.contents}}
                </div>

                <div class="form-group" id="jxform_buttons" style="display: none; margin-bottom: 30px;">
                    <label class="col-md-2 control-label"></label>
                    <div class="col-md-4" style="padding-left: 0px">
                        <button id="jxFormBtnSubmit" type="submit" class="btn btn-labeled btn-primary"  onclick="{{form.submitOnClick}}">
                             <span class="btn-label">
                              <i class="glyphicon glyphicon-ok"></i>
                             </span>
                                    {{label.Apply}}
                        </button>
                        &nbsp;
                        <button type="button" class="btn btn-labeled btn-danger" onclick="location = '{{form.onSubmitCancel}}';">
                             <span class="btn-label">
                              <i class="glyphicon glyphicon-remove"></i>
                             </span>
                            {{label.Cancel}}
                        </button>
                    </div>
                </div>

                <!--<br>-->
            <!--</div>-->
            <!-- end widget div -->

        <!--</div>-->
        <!-- end widget -->

    <!--</div>-->

<!--</article>-->
<!-- WIDGET END -->


<script>

    window.jxTemplateReadyForjxm = function() {
        jxcore.Call('getForm', { form : '{{form.id}}' }, function(param) {
            var div = document.getElementById('jxform');
            if (!div) {
                utils.jxAddMessage("danger", "{{labels.NoDiv}}");
                return;
            }

            if (param.err) {
                utils.jxAddMessage("danger", param.err);
                div.innerHTML = param.err;
            } else {
                $("#jxform_buttons").show();
                div.innerHTML = param.html;

                var script = document.createElement("script");
                script.innerHTML = param.js;
                document.head.appendChild(script);

                // first load of a form applog
                var logDiv = document.getElementById("jxAppLog");
                if (logDiv)
                    utils.jxAppViewLog();

                if (!param.new) {
                    $("#jxAppLog_Tab").removeClass("disabled");
                    $("#jxAppLog_Tab a").attr("href", "applog.html");
                }
            }

            if (param.hideForm) {
                $("#wid-id-0").hide();
            } else {
                $("#wid-id-0").show();
            }

            // focus on first control
            var _this = window.jxForms["{{form.id}}"];
            for(var o in _this.controls) {
                $("#" + o).focus();
                break;
            }
        });

        utils.jxAppViewLog = function(remove) {

            var _this = window.jxForms["{{form.id}}"];

            var lines = null;
            if (remove) {
                lines = -1;
            } else {
                for(var o in _this.controls) {
                    var _t = _this.controls[o]._t;

                    if (_t === "app_log_last_lines")
                       lines = document.getElementById(o).value;
                }
            }

            jxcore.Call('appViewLog', { lines : lines }, function(param) {

                if (param.err) {
                    utils.jxAddMessage('danger', param.err)
                } else {
                    if (param.url) {
                        document.location - param.url;
                        return;
                    }

                    $("#jxAppLog").html(param.log);
                    $("#jxAppLogSize").html((param.size  || 0)+ " bytes");

                    if (param.log && param.log.length)
                        $("#jxAppLogClearBtn").show();
                    else
                        $("#jxAppLogClearBtn").hide();

                }

                if (param.err) {
                    $("#wid-id-0").hide();
                    $("#wid-id-1").hide();
                } else {
                    $("#wid-id-0").show();
                    $("#wid-id-1").show();
                }

            });
            return false;
        };

    };

</script>