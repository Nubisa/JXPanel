<style type="text/css">
    /* Prevent copy paste for all elements except text fields */
    *  { -webkit-user-select:none; -webkit-tap-highlight-color:rgba(255, 255, 255, 0); }
    input, textarea  { -webkit-user-select:text; }
</style>
<link rel="stylesheet" href="/cm/codemirror.css">
<link rel="stylesheet" href="/cm/theme/eclipse.css">
<script src="/cm/codemirror.js"></script>
<script src="/cm/addon/hint/show-hint.js"></script>
<script src="/cm/addon/hint/javascript-hint.js"></script>
<script src="/cm/mode/javascript/javascript.js"></script>
<script src="/cm/addon/fold/foldcode.js"></script>
<link rel="stylesheet" href="/cm/addon/fold/foldgutter.css" />
<script src="/cm/addon/fold/foldgutter.js"></script>
<script src="/cm/addon/fold/brace-fold.js"></script>
<script src="/cm/addon/fold/xml-fold.js"></script>
<script src="/cm/addon/fold/comment-fold.js"></script>
<script src="/cm/mode/xml/xml.js"></script>
<script src="/cm/mode/css/css.js"></script>
<link rel="stylesheet" href="/css/zTreeStyle.css" />

<div class="row" style="padding-bottom:5px;">
    <div class="col-sm-12">
        <div id="editor_files" class="well" style="margin:0px;padding:0px;height:130px;overflow:scroll">

        </div>
    </div>
</div>

<ul id="code_editor_title_holder" class="nav nav-tabs bordered">
    <li class="active">
        <a data-toggle="tab"><i class="fa fa-fw fa-file"></i>{{label.Empty}}</a>
    </li>
</ul>

<div id="code_editor_content_holder" class="tab-content padding-10">
    <div class="tab-pane fade active in" id="s1">
        <p>
        <div id="_code_editor_host" class="well" style="margin:0px;padding:0px;border:dotted 1px #ccc;height: 320px;overflow:hidden">

        </div>
        </p>
    </div>
</div>

<script>

    var clearSelection = function(){
        var title_holder = document.getElementById('code_editor_title_holder');
        var content_holder = document.getElementById('code_editor_content_holder');

        for(var o in title_holder._childs){
            if(!title_holder._childs[o])
                continue;
            title_holder._childs[o].className = "";
        }

        for(var o in content_holder._childs){
            if(!content_holder._childs[o])
                continue;
            content_holder._childs[o].className = "tab-pane fade";
        }
    };

    var removeTab = function(id){
        var title_holder = document.getElementById('code_editor_title_holder');
        var content_holder = document.getElementById('code_editor_content_holder');

        title_holder.count--;

        title_holder.removeChild(title_holder._childs[id]);
        title_holder._childs[id] = null;
        delete(title_holder._childs[id]);
        content_holder.removeChild(content_holder._childs[id]);
        content_holder._childs[id] = null;
        delete(content_holder._childs[id]);
    };

    var createTab = function(id, title){
        var title_holder = document.getElementById('code_editor_title_holder');
        var content_holder = document.getElementById('code_editor_content_holder');

        if(!title_holder._childs){
            title_holder._childs = {};
            title_holder.innerHTML = "";
            content_holder.innerHTML = "";
            content_holder._childs = {};
            title_holder.count = 0;
        }else{
            clearSelection();
            for(var o in title_holder._childs){
                if(title_holder._childs[o]._name == "{{label.Empty}}"){
                    removeTab(o);
                    break;
                }
            }
        }

        var div = document.createElement("div");
        div.id = id;
        div.className = "tab-pane fade active in";
        var pp = document.createElement("p");
        var div_code_editor = document.createElement("div");
        div_code_editor.id = id + "_code_editor";
        div_code_editor.className = "well";
        div_code_editor.style.cssText = "margin:0px;padding:0px;border:dotted 1px #ccc;height: 320px;overflow:hidden";
        pp.appendChild(div_code_editor);
        div.appendChild(pp);
        content_holder.appendChild(div);
        div._editor = div_code_editor;
        content_holder._childs[id] = (div);

        var li = document.createElement('li');
        li._name = title;
        li.className = 'active';
        var a = document.createElement('a');
        a.style.cursor = "pointer";
        a._target = id;
        a.onclick = function(){
            if(!title_holder._childs[this._target])
                return false;
            clearSelection();
            title_holder._childs[this._target].className = "active";
            content_holder._childs[this._target].className = "tab-pane fade active in";
        };
        a["data-toggle"] = "tab";

        a.innerHTML = '<i class="fa fa-fw fa-file"></i>' + title;
        li.appendChild(a);
        li._a = a;

        var ax = document.createElement('a');
        ax.style.cursor = "pointer";
        ax._target = id;
        ax.onclick = function(){
            clearSelection();
            var old = "", break_next = false;
            for(var o in title_holder._childs){
                if(!title_holder._childs[o])
                    continue;

                old = o;
                if(break_next)
                    break;
                if(o == this._target){
                    if(old === o){
                        break_next  = true;
                        continue;
                    }
                    break;
                }
            }

            removeTab(this._target);

            if(old == this._target && !title_holder.count){
                createTab("xo" + Date.now(), "{{label.Empty}}");
            }
            else{
                if(!title_holder._childs[old]){
                    for(var o in title_holder._childs){
                        old = o;
                        break;
                    }
                }

                title_holder._childs[old].className = "active";
                content_holder._childs[old].className = "tab-pane fade active in";
            }

            return false;
        };
        ax.innerHTML = '<i class="fa fa-fw fa-times"></i>';
        a.appendChild(ax);

        title_holder.appendChild(li);
        title_holder._childs[id] = (li);

        title_holder.count++;

        return div_code_editor;
    };

    var editorInter = setInterval(function(){

        if(typeof jQuery != 'undefined' && typeof CodeMirror != 'undefined' && typeof jxcore != 'undefined' && jxcore.IsConnected){
            var elm_editor = document.getElementById("code_editor_content_holder");
            clearInterval(editorInter);
            var scr = document.createElement("script");
            scr.src = "/js/jquery.ztree.core-3.5.min.js";
            elm_editor.parentNode.appendChild(scr);
            Init();
        }
    }, 10);

    var Init = function(){
        var editors = {};

        var loadMode = function(loc){
            var elm_editor = document.getElementById("code_editor_content_holder");
            var scr = document.createElement("script");
            scr.src = "/cm/mode/" + loc;
            elm_editor.parentNode.appendChild(scr);
        };

        var editor_count = 0;

        var createEditor = function(type, _fname, location){
            var fname = _fname;
            if(!fname)
                fname = "{{label.Empty}}";

            var host_editor = createTab("jx_e_" + (editor_count++), fname);
            host_editor.innerHTML = "";
            var elm_editor = document.createElement("textarea");
            elm_editor.id = "_code_editor";
            elm_editor.height = 300;

            host_editor.appendChild(elm_editor);
            var opts = {
                mode: type,
                theme: "eclipse",
                lineNumbers:true,
                lineWrapping:true,
                foldGutter: true,
                gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"]
            };
            var btn = null;
            if(!_fname)
                opts.readOnly = true;
            else{
                btn = document.createElement("button");
                btn.className = "btn btn-success";
                btn.style.cssText = "padding-top:5px;margin-top:5px";
                btn._name = fname;
                btn._location = location;
                btn.onclick = function(){
                    var _this = this;
                    jxcore.Call("saveFile", {up:this._location, src:escape(editors[this._name].getValue())}, function(ret_val){
                        if(ret_val.err){
                            alert(ret_val.err);
                            if(ret_val.relogin){
                                location.href = "/index.html";
                            }
                            return;
                        };
                        utils.bubble("success", "{{label.FileSavedTitle}}", "{{label.FileSavedContent}}", 4000);
                        _this.disabled = "disabled";
                    });
                };
                btn.innerHTML += '<i class="fa fa-fw fa-save"></i>{{label.Save}}';
                btn.disabled = "disabled";
                host_editor.parentNode.appendChild(btn);
            }

            editors[fname] = CodeMirror.fromTextArea(elm_editor, opts);
            editors[fname].btn = btn;
            if(_fname){
                editors[fname].on('change', function(inst, obj){
                    if(btn.loaded)
                        btn.disabled = null;
                    else
                        btn.loaded = true;
                });
            }
        };

        var checkExtension = function(loc, arr){
            for(var o in arr){
              if(loc.lastIndexOf(arr[o]) === loc.length - (arr[o].length))
                return true;
            }
            return false;
        };
        var setting = {
            callback: {
                onClick: function(ev, treeId, treeNode, clickFlag) {
                    var zTree = $.fn.zTree.getZTreeObj(treeId);

                    if(zTree.jx_loading){
                        return false;
                    }

                    var loc = treeNode.name;
                    var _node = treeNode;
                    while(_node && _node.parentTId){
                        var parent = zTree.getNodeByTId(_node.parentTId);
                        if(parent){
                            loc = parent.name + "/" + loc;
                            _node = parent;
                        }
                        else{
                            _node = null;
                        }
                    }

                    if(treeNode.children && treeNode.children.length){
                        zTree.jx_loading = true;
                        getFiles(loc, treeId, treeNode);
                    }else{
                        var _loc = loc.toLowerCase();

                        if(checkExtension(_loc, [".js", ".json", ".jxp"])){
                           getFile(treeNode.name, loc, treeId, "text/javascript");
                           return;
                        }

                        if(checkExtension(_loc, [".css"])){
                            getFile(treeNode.name, loc, treeId, "css");
                            return;
                        }

                        if(checkExtension(_loc, [".php"])){
                            loadMode("php/php.js");
                            getFile(treeNode.name, loc, treeId, "php");
                            return;
                        }

                        if(checkExtension(_loc, [".go"])){
                            loadMode("go/go.js");
                            getFile(treeNode.name, loc, treeId, "go");
                            return;
                        }

                        if(checkExtension(_loc, [".md", ".conf", ".ini", ".htaaccess"])){
                            loadMode("markdown/markdown.js");
                            getFile(treeNode.name, loc, treeId, "markdown");
                            return;
                        }

                        if(checkExtension(_loc, [ ".htm", ".html", ".xml"])){
                            getFile(treeNode.name, loc, treeId, "xml");
                            return;
                        }

                        if(checkExtension(_loc, [".coffee"])){
                            loadMode("coffeescript/coffeescript.js");
                            getFile(treeNode.name, loc, treeId, "coffeescript");
                            return;
                        }

                        if(checkExtension(_loc, [".txt", ".ini", ".java", ".cs", ".aspx", ".lua", ".vb", ".sql", ".perl", ".c", ".cc", ".cpp", ".hpp", ".h", ".gitignore"])){
                            getFile(treeNode.name, loc, treeId, "text");
                            return;
                        }

                        utils.bubble("warning", "{{label.FileTypeNotSupportedTitle}}", "{{label.FileTypeNotSupportedContent}}", 4000);
                    }
                }
            }
        };

        var getFiles = function(folder, treeId, treeNode){
            jxcore.Call("getFiles", {up:folder, id:treeId}, function(ret_val){

                if(ret_val.err){
                    alert(ret_val.err);
                    if(ret_val.relogin){
                        location.href = "/index.html";
                    }
                    var zTree = $.fn.zTree.getZTreeObj(ret_val.id);
                    if(zTree)
                        zTree.jx_loading = false;
                    return;
                }

                if(!treeNode){
                    $.fn.zTree.init($("#"+treeId), setting, ret_val.nodes);
                }
                else{
                    var zTree = $.fn.zTree.getZTreeObj(ret_val.id);

                    zTree.jx_loading = false;
                    zTree.removeChildNodes(treeNode);

                    zTree.addNodes(treeNode, ret_val.nodes);

                    zTree.expandNode(treeNode, true, false);
                }
            });
        };

        var getFile = function(fname, location, treeId, type){
            var title_holder = document.getElementById('code_editor_title_holder');
            for(var o in title_holder._childs){
                if(title_holder._childs[o]._name == fname){
                    title_holder._childs[o]._a.onclick();
                    return;
                }
            }

            jxcore.Call("getFile", {up:location, id:treeId, tp:type, fn:fname}, function(ret_val){

                if(ret_val.err){
                    alert(ret_val.err);

                    if(ret_val.relogin){
                        location.href = "/index.html";
                    }
                    if(ret_val.reloadTree){
                        location.href = "/codeEditor.html";
                    }
                    return;
                }

                createEditor(ret_val.tp, ret_val.fn, ret_val.loc);
                editors[ret_val.fn].setValue(ret_val.source);
            });
        };

        function createTree(){
            var files_host = document.getElementById("editor_files");
            var host = document.createElement("ul");
            host.id="files_{{defaults.getUniqueId}}";
            host.className="ztree";
            files_host.appendChild(host);

            getFiles("/", host.id, null);

            createEditor("text/javascript", null);
        }

        var loadTreeInter = setInterval(function(){
            if($.fn.zTree){
                clearInterval(loadTreeInter);
                createTree();
            }
        }, 10);
    };
</script>


