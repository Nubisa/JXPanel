<script>
    if(!window.jxForms){
        window.jxForms = {};
    }

    window.jxForms["{{form.id}}"] = {
        ntc : {},
        apply:function(){
            var _this = window.jxForms["{{form.id}}"];

            var values = {};
            var failed = false;
            utils.jxAddMessage();

            // hiding previous errors
            _this.hideErrors();

            $("input").each(function(index, el) {

                var isRequired = $(el).hasClass("required");
                var type = $(el).attr('type');
                var val = type === 'checkbox' ? el.checked : el.value;
                var empty = (type === 'checkbox' && !val) || (type !== 'checkbox' && !val.trim().length);

                if (isRequired && empty) {
                    _this.showError(this.id, "{{label.ValueRequired}}");
                    failed = true;
                    return;
                }

                values[this.id] = val;
            });

            $("select").each(function(index, el) {

                var isRequired = $(el).hasClass("required");
                var selected = $(el).find('option:selected');

                if (isRequired && !selected.index()) {
                    _this.showError(this.id, "{{label.ValueRequired}}");
                    failed = true;
                    return;
                }

                values[this.id] = selected.index() ? selected.val() : "";
            });

            $("textarea").each(function(index, el) {

                var isRequired = $(el).hasClass("required");
                var val = el.value;
                var empty = !val.trim().length;

                if (isRequired && empty) {
                    _this.showError(this.id, "{{label.ValueRequired}}");
                    failed = true;
                    return;
                }

                values[this.id] = val;
            });


            if(!failed){
                window.toServer('sessionApply', {form: '{{form.id}}', controls: values }, function (param) {

                    var ntc_displayed = false;
                    if (param.arr) {
                        _this.hideErrors();
                        for(var o in param.arr) {
                            if (param.arr[o].ntc && !ntc_displayed) { // need to confirm

                                var ntc = param.arr[o].ntc;
                                utils.jxConfirm('<i class="fa fa-user txt-color-orangeDark"></i> ' + ntc.title, ntc.msg, function(ButtonPressed) {

                                    if (ButtonPressed === "{{label.Yes}}") {

                                        _this.ntc[ntc.id] = ntc.id_ok;
                                        var div = document.getElementById(ntc.id_ok + '_group');
                                        if (!div)
                                            $(ntc.html).insertAfter("#" + ntc.id + "_group");

                                        $('#' + ntc.id_ok).prop("checked", true);
                                        $('#' + ntc.id_ok + '_group').css("margin-top","-20px");
//                                        setTimeout(_this.apply, 50);
                                    } else {
                                        _this.showError(ntc.id, ntc.title);
                                    }
                                });
                                ntc_displayed = true;
                            } else {
                                _this.showError(param.arr[o].id, param.arr[o].msg);
                            }
                        }
                    } else {
                        document.location = "{{form.onSubmitSuccess}}";
                    }
                }, true);
            }
        },
        hideErrors : function() {
            var _this = window.jxForms["{{form.id}}"];
            $("input, select").each(function() {
                $("#" + this.id + "_note").remove();
                $("#" + this.id + "_group").removeClass("has-error");
                //                $("#" + o + "_group").addClass("has-success");
            });
            _this.focused = false;
        },
        showError : function(id, msg) {

            var _this = window.jxForms["{{form.id}}"];

            if (id && document.getElementById(id)) {
                var str = '<span class="help-block" id="'+id+'_note" style="margin-bottom: 0px;"><i class="fa fa-warning"></i> ' + msg + '</span>';
                $(str).insertAfter("#" + id);
//                $("#" + id + "_group").removeClass("has-success");
                $("#" + id + "_group").addClass("has-error");
            } else {
                utils.jxAddMessage('danger', msg);
            }

            if (!_this.focused) {
                _this.focused = true;

                var _input = $("#" + id);

                // activating proper tab
                _input.parents(".tab-pane").each(function(id, el) {
                    var id = el.id.replace('tab-pane-', '');
                    $("#" + id).parent().children().removeClass("active");
                    $("#" + id).addClass("active");
                });

                // displaying proper tab pane
                _input.parents(".tab-content").children(".tab-pane").removeClass("active in");
                _input.parents(".tab-pane").addClass("active in");

                _input.focus();
                window.scrollBy(0,-100);
            }
        }
    };
</script>