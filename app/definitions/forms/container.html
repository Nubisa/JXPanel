<script>
    if(!window.jxForms){
        window.jxForms = {};
    }

    window.jxForms["{{form.id}}"] = {
        apply:function(){
            var _this = window.jxForms["{{form.id}}"];

            var values = {};
            var failed = false;
            utils.jxAddMessage();

            // hiding previous errors
            _this.hideErrors();

            $("input").each(function(index, el) {

                var isRequired = $(el).hasClass("required");
                var type = $(el).attr('type');
                var val = type === 'checkbox' ? el.checked : el.value;
                var empty = (type === 'checkbox' && !val) || (type !== 'checkbox' && !val.trim().length);

                if (isRequired && empty) {
                    _this.showError(this.id, "{{label.ValueRequired}}");
                    failed = true;
                    return;
                }

                values[this.id] = val;
            });

            $("select").each(function(index, el) {

                var isRequired = $(el).hasClass("required");
                var selected = $(el).find('option:selected');

                if (isRequired && !selected.index()) {
                    _this.showError(this.id, "{{label.ValueRequired}}");
                    failed = true;
                    return;
                }

                values[this.id] = selected.index() ? selected.val() : "";
            });

            $("textarea").each(function(index, el) {

                var isRequired = $(el).hasClass("required");
                var val = el.value;
                var empty = !val.trim().length;

                if (isRequired && empty) {
                    _this.showError(this.id, "{{label.ValueRequired}}");
                    failed = true;
                    return;
                }

                values[this.id] = val;
            });


            if(!failed){
                window.toServer('sessionApply', {form: '{{form.id}}', controls: values }, function (param) {

                    if (param.arr) {
                        _this.hideErrors();
                        for(var o in param.arr)
                            _this.showError(param.arr[o].id, param.arr[o].msg);
                    } else {
                        document.location = "{{form.onSubmitSuccess}}";
                    }
                }, true);
            }
        },
        hideErrors : function() {
            var _this = window.jxForms["{{form.id}}"];
            $("input, select").each(function() {
                $("#" + this.id + "_note").remove();
                $("#" + this.id + "_group").removeClass("has-error");
                //                $("#" + o + "_group").addClass("has-success");
            });
            _this.focused = false;
        },
        showError : function(id, msg) {

            var _this = window.jxForms["{{form.id}}"];

            if (id && document.getElementById(id)) {
                var str = '<span class="help-block" id="'+id+'_note"><i class="fa fa-warning"></i> ' + msg + '</span>';
                $(str).insertAfter("#" + id);
//                $("#" + id + "_group").removeClass("has-success");
                $("#" + id + "_group").addClass("has-error");
            } else {
                utils.jxAddMessage('danger', msg);
            }

            if (!_this.focused) {
                _this.focused = true;
                $("#" + id).focus();
                window.scrollBy(0,-100);
            }
        }
    };
</script>

<!--<article class="col-sm-12 col-md-16 col-lg-12">-->
<!--<article class="sortable-grid ui-sortable">-->

    <!-- Widget ID (each widget will need unique ID)-->
    <!--<div class="jarviswidget jarviswidget-color-darken" id="wid-id-0" data-widget-togglebutton="false" data-widget-editbutton="false" data-widget-deletebutton="false" style="display: none;">-->

        <!--<header>-->
            <!--{{form.icon}}-->
            <!--<h2 style="width:1px;overflow:visible"><nobr><strong>{{form.displayName}}</strong></nobr></h2>-->

        <!--</header>-->

        <!-- widget div-->
        <!--<div>-->

            <!-- widget edit box -->
            <!--<div class="jarviswidget-editbox">-->


            <!--</div>-->
            <!-- end widget edit box -->

            <!-- widget content -->
            <!--<div class="widget-body">-->

                <div id="jxform">
                    {{form.contents}}
                </div>

                <div class="form-group" id="jxform_buttons" style="display: none; margin-bottom: 30px;">
                    <label class="col-md-2 control-label"></label>
                    <div class="col-md-4" style="padding-left: 0px">
                        <button id="jxFormBtnSubmit" type="submit" class="btn btn-labeled btn-primary"  onclick="{{form.submitOnClick}}">
                             <span class="btn-label">
                              <i class="glyphicon glyphicon-ok"></i>
                             </span>
                                    {{label.Apply}}
                        </button>
                        &nbsp;
                        <button type="button" class="btn btn-labeled btn-danger" onclick="location = '{{form.onSubmitCancel}}';">
                             <span class="btn-label">
                              <i class="glyphicon glyphicon-remove"></i>
                             </span>
                            {{label.Cancel}}
                        </button>
                    </div>
                </div>

                <br>
            <!--</div>-->
            <!-- end widget div -->

        <!--</div>-->
        <!-- end widget -->

    <!--</div>-->

<!--</article>-->
<!-- WIDGET END -->


<script>

    window.jxTemplateReadyForjxm = function() {
        jxcore.Call('getForm', { form : '{{form.id}}' }, function(param) {
            var div = document.getElementById('jxform');
            if (!div) {
                utils.jxAddMessage("danger", "{{labels.NoDiv}}");
                return;
            }

            if (param.err) {
                utils.jxAddMessage("danger", param.err);
                div.innerHTML = param.err;
            } else {
                $("#jxform_buttons").show();
                div.innerHTML = param.html;

                var script = document.createElement("script");
                script.innerHTML = param.js;
                document.head.appendChild(script);

                // first load of a form applog
                var logDiv = document.getElementById("jxAppLog");
                if (logDiv)
                    utils.jxAppViewLog();

                if (!param.new) {
                    $("#jxAppLog_Tab").removeClass("disabled");
                    $("#jxAppLog_Tab a").attr("href", "applog.html");
                }
            }

            if (param.hideForm) {
                $("#wid-id-0").hide();
            } else {
                $("#wid-id-0").show();
            }

            // focus on first control
            $("input, select").first().focus();
        });

        utils.jxAppViewLog = function(remove) {

            var _this = window.jxForms["{{form.id}}"];

            var values = {};
            if (remove) {
                values = -1;
            } else {
                $("input").each(function(index, el) {
                    values[this.id] = el.value;
                });
            }

            jxcore.Call('appViewLog', { controls : values }, function(param) {

                if (param.err) {
                    utils.jxAddMessage('danger', param.err)
                } else {
                    if (param.url) {
                        document.location = param.url;
                        return;
                    }

                    $("#jxAppLog").html(param.log);
                    $("#jxAppLogSize").html((param.size  || 0)+ " bytes");

                    if (param.log && param.log.length)
                        $("#jxAppLogClearBtn").show();
                    else
                        $("#jxAppLogClearBtn").hide();

                }

                if (param.err) {
                    $("#wid-id-0").hide();
                    $("#wid-id-1").hide();
                } else {
                    $("#wid-id-0").show();
                    $("#wid-id-1").show();
                }

            });
            return false;
        };

    };

</script>